<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Warming: A Data-Driven Story</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }
        header {
            text-align: center;
            padding: 32px 0 24px 0;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.09);
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            font-size: 2.1em;
            margin: 0 0 10px 0;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 1.15em;
        }
        .scene-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 24px;
            position: relative;
            min-height: 660px;
            /* reserve space for key insight */
        }
        .scene-title {
            font-size: 1.35em;
            color: #34495e;
            margin-bottom: 10px;
            text-align: center;
        }
        .scene-description {
            color: #636e72;
            text-align: center;
            margin-bottom: 18px;
            line-height: 1.6;
        }
        #visualization {
            width: 100%;
            min-height: 500px;
            position: relative;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.97);
            border-radius: 10px;
        }
        .nav-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 22px;
            font-size: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .nav-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .scene-indicator {
            display: flex;
            gap: 8px;
        }
        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #bdc3c7;
            transition: background 0.2s;
        }
        .indicator-dot.active {
            background: #3498db;
        }
        .axis {
            font-size: 14px;
        }
        .axis-label {
            font-size: 15px;
            font-weight: 600;
            fill: #374151;
        }
        .line { fill: none; stroke-width: 3; }
        .temperature-line { stroke: #e74c3c; }
        .co2-line { stroke: #f39c12; }
        .projection-line { stroke-width: 2.5; }
        .area { fill-opacity: 0.2; }
        .temperature-area { fill: #e74c3c; }
        .co2-area { fill: #f39c12; }
        .grid line { stroke: #ecf0f1; stroke-opacity: 0.7; }
        .tooltip {
            position: absolute;
            padding: 10px 14px;
            background: rgba(30, 42, 62, 0.96);
            color: #fff;
            border-radius: 6px;
            pointer-events: none;
            font-size: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.16);
            border: 1px solid #3498db;
        }
        .legend {
            font-size: 15px;
        }
        .annotation-note-title {
            font-weight: 700;
            font-size: 15px;
            fill: #34495e !important;
            color: #34495e !important;
        }
        .annotation-note-label {
            font-size: 14px;
            fill: #283747 !important;
            color: #283747 !important;
        }
        .annotation-label, .annotation-note-label, .annotation-note-title {
            paint-order: stroke fill;
            stroke: #fff;
            stroke-width: 2.5px;
        }
        .interactive-prompt {
            text-align: center;
            color: #1976d2;
            font-style: italic;
            margin-top: 8px;
            font-size: 1.07em;
            opacity: 0;
            animation: fadeIn 2s forwards;
            animation-delay: 1s;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .key-insight {
            background: #ecf0f1;
            padding: 12px 18px;
            border-left: 4px solid #3498db;
            margin: 30px 0 0 0;
            border-radius: 5px;
            color: #212121;
            font-size: 1.08em;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        @media (max-width: 1024px) {
            .container { padding: 2vw; max-width: 100vw; }
            .scene-container { min-height: 540px; }
            #visualization { min-height: 320px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>The Rising Temperature: A Global Warming Story</h1>
        <p class="subtitle">An Interactive Journey Through Climate Data (1959-2023)</p>
    </header>

    <div class="scene-container">
        <h2 class="scene-title" id="sceneTitle">Loading...</h2>
        <p class="scene-description" id="sceneDescription">Preparing visualization...</p>
        <div id="visualization"></div>
        <p class="interactive-prompt" id="interactivePrompt"></p>
        <div class="key-insight" id="keyInsight"></div>
    </div>

    <div class="navigation">
        <button class="nav-button" id="prevBtn" onclick="previousScene()" disabled>Previous</button>
        <div class="scene-indicator" id="sceneIndicator"></div>
        <button class="nav-button" id="nextBtn" onclick="nextScene()">Next</button>
    </div>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
    let currentScene = 0;
    let data = null;
    const margin = {top: 42, right: 75, bottom: 60, left: 75};
    const width = 900 - margin.left - margin.right;
    const height = 450 - margin.top - margin.bottom;
    
    const scenes = [
        {
            title: "The Warming Trend: Temperature Change over the decades",
            description: "Since 1959, global temperatures have shown a clear upward trend. This visualization shows the temperature anomaly - the difference from the 20th century average.",
            type: "temperature",
            interactive: false,
            prompt: "",
            insight: "Long-term records show a persistent rise in global temperature. Recent years have set new records for warmth, driven by human activities."
        },
        {
            title: "Accelerating Change: Temperature Rise by Decade",
            description: "Notice how the rate of warming has accelerated dramatically since the 1980s. Each decade shows progressively higher temperatures.",
            type: "temperature-decades",
            interactive: true,
            prompt: "Hover over the chart to explore temperature changes by decade",
            insight: "Warming is not linear—recent decades have seen the steepest increases in global temperature."
        },
        {
            title: "The CO₂ Connection: Emissions and Temperature",
            description: "The relationship between CO₂ emissions and temperature rise is clear. As emissions have increased, so have global temperatures.",
            type: "co2-temperature",
            interactive: true,
            prompt: "Click on data points to see detailed information about specific years",
            insight: "CO₂ and temperature track closely, with an R² > 0.9—making emissions a strong predictor for warming."
        },
        {
            title: "Future Projections: Where Are We Heading?",
            description: "Based on current trends, scientists project significant temperature increases by 2100. Different scenarios depend on our actions today.",
            type: "projections",
            interactive: true,
            prompt: "Explore different emission scenarios by clicking the legend items",
            insight: "The difference between scenarios represents millions of lives and trillions in economic impact. Every fraction of a degree matters."
        }
    ];
    
    async function init() {
        data = await loadClimateData();
        // Scene indicators
        const indicatorContainer = d3.select("#sceneIndicator");
        indicatorContainer.selectAll("*").remove();
        scenes.forEach((_, i) => {
            indicatorContainer.append("div")
                .attr("class", "indicator-dot")
                .classed("active", i === 0);
        });
        loadScene(0);
    }
    
    async function loadClimateData() {
        const [tempData, co2Data] = await Promise.all([
            d3.csv("data/temperature.csv", d => ({
                year: +d.year,
                temperature: +d.temperature
            })),
            d3.csv("data/co2.csv", d => ({
                year: +d.year,
                co2: +d.co2
            }))
        ]);
        let merged = tempData.map(d => {
            let co2Row = co2Data.find(c => c.year === d.year);
            return {
                year: d.year,
                temperature: d.temperature,
                co2: co2Row ? co2Row.co2 : null,
                decade: Math.floor(d.year / 10) * 10
            };
        });
        return merged.filter(d => d.co2 !== null && !isNaN(d.temperature));
    }
    
    function loadScene(sceneIndex) {
        currentScene = sceneIndex;
        const scene = scenes[sceneIndex];
        document.getElementById("sceneTitle").textContent = scene.title;
        document.getElementById("sceneDescription").textContent = scene.description;
        document.getElementById("interactivePrompt").textContent = scene.prompt || "";
        document.getElementById("prevBtn").disabled = sceneIndex === 0;
        document.getElementById("nextBtn").disabled = sceneIndex === scenes.length - 1;
        d3.selectAll(".indicator-dot").classed("active", (d, i) => i === sceneIndex);
        d3.select("#visualization").selectAll("*").remove();
    
        // Always update single key insight
        document.getElementById("keyInsight").innerHTML = `<strong>Key Insight:</strong> ${scene.insight || ""}`;
    
        switch(scene.type) {
            case "temperature":
                createTemperatureChart();
                break;
            case "temperature-decades":
                createDecadeChart();
                break;
            case "co2-temperature":
                createCO2TemperatureChart();
                break;
            case "projections":
                createProjectionChart();
                break;
        }
    }
    
    // ---- Scene 1: Temperature Trend ----
    function createTemperatureChart() {
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
    
        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    
        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.year))
            .range([0, width]);
    
        const yScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.temperature))
            .range([height, 0]).nice();
    
        // Grid
        g.append("g").attr("class", "grid")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(""));
        g.append("g").attr("class", "grid")
            .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(""));
    
        // Area
        const area = d3.area()
            .x(d => xScale(d.year))
            .y0(height)
            .y1(d => yScale(d.temperature))
            .curve(d3.curveMonotoneX);
        g.append("path")
            .datum(data)
            .attr("class", "area temperature-area")
            .attr("d", area);
    
        // Line
        const line = d3.line()
            .x(d => xScale(d.year))
            .y(d => yScale(d.temperature))
            .curve(d3.curveMonotoneX);
        g.append("path")
            .datum(data)
            .attr("class", "line temperature-line")
            .attr("d", line);
    
        // Axes
        g.append("g").attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
        g.append("g").attr("class", "axis")
            .call(d3.axisLeft(yScale));
    
        // Labels
        g.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 22)
            .attr("x", 0 - (height / 2))
            .attr("text-anchor", "middle")
            .text("Temperature Anomaly (°C)");
        g.append("text").attr("class", "axis-label")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 12)
            .attr("text-anchor", "middle")
            .text("Year");
    
        // Annotations - moved to always visible, well-contrasted position
        const annotations = [
            {
                note: {
                    title: "Early Warming",
                    label: "Reliable data begins in 1960"
                },
                x: xScale(1961), y: yScale(data.find(d => d.year === 1961).temperature),
                dy: -32, dx: 40
            },
            {
                note: {
                    title: "Acceleration",
                    label: "Rate of increase doubled after 1980"
                },
                x: xScale(1982), y: yScale(data.find(d => d.year === 1982).temperature),
                dy: -54, dx: -50
            },
            {
                note: {
                    title: "Recent Extremes",
                    label: "Warmest years: 2016–2023"
                },
                x: xScale(2022), y: yScale(data.find(d => d.year === 2022).temperature),
                dy: -38, dx: -100
            }
        ];
        g.append("g").call(
            d3.annotation()
                .annotations(annotations)
                .notePadding(5)
        );
    }
    
    // ---- Scene 2: Decade Chart with Bar Interactivity ----
    function createDecadeChart() {
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
    
        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    
        // Group by decade
        const decadeData = d3.rollup(
            data,
            v => d3.mean(v, d => d.temperature),
            d => d.decade
        );
        const decades = Array.from(decadeData, ([decade, temp]) => ({decade, temp}));
    
        const xScale = d3.scaleBand()
            .domain(decades.map(d => d.decade))
            .range([0, width])
            .padding(0.14);
        const yScale = d3.scaleLinear()
            .domain([d3.min(decades, d => d.temp) - 0.15, d3.max(decades, d => d.temp) + 0.15])
            .range([height, 0]);
        const colorScale = d3.scaleSequential()
            .domain([d3.max(decades, d => d.temp), d3.min(decades, d => d.temp)])
            .interpolator(d3.interpolateRdYlBu);
    
        // Bars
        g.selectAll(".bar")
            .data(decades)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => xScale(d.decade))
            .attr("y", d => yScale(d.temp))
            .attr("width", xScale.bandwidth())
            .attr("height", d => height - yScale(d.temp))
            .attr("fill", d => colorScale(d.temp))
            .on("mousemove", function(event, d) {
                d3.select(this).attr("opacity", 0.8);
                const prev = decades[decades.findIndex(dec => dec.decade === d.decade) - 1];
                showTooltip(event, `<strong>${d.decade}s</strong><br>
                    Avg Temp Anomaly: <b>${d.temp.toFixed(3)}°C</b><br>
                    Change from previous: ${prev ? "+" + ((d.temp - prev.temp) * 100).toFixed(2) + "%" : "N/A"}`);
            })
            .on("mouseleave", function() {
                d3.select(this).attr("opacity", 1);
                hideTooltip();
            });
    
        // Axes
        g.append("g").attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickFormat(d => d + "s"));
        g.append("g").attr("class", "axis").call(d3.axisLeft(yScale));
    
        // Labels
        g.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 20)
            .attr("x", 0 - (height / 2))
            .attr("text-anchor", "middle")
            .text("Avg Temp Anomaly (°C)");
        g.append("text").attr("class", "axis-label")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 12)
            .attr("text-anchor", "middle")
            .text("Decade");
    
        // Trend line
        const trendLine = d3.line()
            .x(d => xScale(d.decade) + xScale.bandwidth() / 2)
            .y(d => yScale(d.temp));
        g.append("path")
            .datum(decades)
            .attr("fill", "none")
            .attr("stroke", "#e74c3c")
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,4")
            .attr("d", trendLine);
    
        // Key annotation - repositioned, contrast fixed
        const recents = decades.slice(-3);
        g.append("g").call(
            d3.annotation()
            .annotations([{
                note: {
                    title: "Unprecedented Acceleration",
                    label: "Last three decades = steepest temperature rise"
                },
                x: xScale(recents[1].decade) + xScale.bandwidth() / 2,
                y: yScale(recents[1].temp),
                dy: -78, dx: 0,
                type: d3.annotationCalloutElbow
            }])
            .notePadding(6)
        );
    }

    // ---- Scene 3: CO2 and Temperature Scatter with Tooltip ----
    function createCO2TemperatureChart() {
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
    
        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    
        const xScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.co2))
            .range([0, width]);
        const yScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.temperature))
            .range([height, 0]);
        const colorScale = d3.scaleSequential()
            .domain(d3.extent(data, d => d.year))
            .interpolator(d3.interpolateViridis);
    
        // Grid
        g.append("g").attr("class", "grid")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(""));
        g.append("g").attr("class", "grid")
            .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(""));
    
        // Scatter
        g.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("cx", d => xScale(d.co2))
            .attr("cy", d => yScale(d.temperature))
            .attr("r", 3.5)
            .attr("fill", d => colorScale(d.year))
            .attr("opacity", 0.9)
            .on("mouseover", function(event, d) {
                d3.select(this).attr("stroke", "#374151").attr("stroke-width", 2);
                showTooltip(event, `Year: <b>${d.year}</b><br>CO₂: ${d.co2.toFixed(1)} ppm<br>Temp Anomaly: ${d.temperature.toFixed(3)}°C`);
            })
            .on("mouseout", function() {
                d3.select(this).attr("stroke", "none");
                hideTooltip();
            });
    
        // Regression line and stats
        const regression = calculateRegression(data.map(d => [d.co2, d.temperature]));
        const regressionData = [
            [d3.min(data, d => d.co2), 0],
            [d3.max(data, d => d.co2), 0]
        ];
        const regressionLine = d3.line()
            .x(d => xScale(d[0]))
            .y(d => yScale(regression.predict(d[0])));
        g.append("path")
            .datum(regressionData)
            .attr("fill", "none")
            .attr("stroke", "#e74c3c")
            .attr("stroke-width", 2.5)
            .attr("stroke-dasharray", "5,4")
            .attr("d", regressionLine);
    
        // Axes
        g.append("g").attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale));
        g.append("g").attr("class", "axis").call(d3.axisLeft(yScale));
    
        // Labels
        g.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 22)
            .attr("x", 0 - (height / 2))
            .attr("text-anchor", "middle")
            .text("Temperature Anomaly (°C)");
        g.append("text").attr("class", "axis-label")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 12)
            .attr("text-anchor", "middle")
            .text("CO₂ Concentration (ppm)");
    
        // Color legend
        const legendWidth = 180, legendHeight = 12;
        const legendScale = d3.scaleLinear()
            .domain(d3.extent(data, d => d.year))
            .range([0, legendWidth]);
        const legend = g.append("g")
            .attr("transform", `translate(${width - legendWidth - 12}, 22)`);
        const gradientId = "gradient-co2";
        const gradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", gradientId);
        for (let i = 0; i <= 10; i++) {
            gradient.append("stop")
                .attr("offset", `${i * 10}%`)
                .attr("stop-color", colorScale(legendScale.invert(i * legendWidth / 10)));
        }
        legend.append("rect")
            .attr("width", legendWidth)
            .attr("height", legendHeight)
            .style("fill", `url(#${gradientId})`)
            .attr("stroke", "#95a5a6").attr("stroke-width", 1);
        legend.append("text").attr("y", -6).attr("font-size", 13).text("Year");
        legend.append("text").attr("y", legendHeight + 16).attr("font-size", 12)
            .text(d3.min(data, d => d.year));
        legend.append("text").attr("x", legendWidth)
            .attr("y", legendHeight + 16)
            .attr("text-anchor", "end").attr("font-size", 12)
            .text(d3.max(data, d => d.year));
    
        // Static annotation
        g.append("g").call(
            d3.annotation().annotations([{
                note: {
                    title: "Strong Correlation",
                    label: `R² = ${regression.r2.toFixed(3)}\nCO₂ and temperature move together`
                },
                x: width - 140, y: 82,
                dx: 0, dy: 0,
                type: d3.annotationLabel
            }]).notePadding(4)
        );
    }
    
    // ---- Scene 4: Projections ----
    function createProjectionChart() {
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        const lastYear = 2023;
        const projectionYears = Array.from({length: 2100-lastYear}, (_, i) => lastYear + 1 + i);
    
        // Scenarios
        const scenarios = {
            "Current Path": projectionYears.map(year => ({
                year, temperature: data[data.length-1].temperature + (year - lastYear)*0.035
            })),
            "Aggressive Action": projectionYears.map(year => ({
                year, temperature: data[data.length-1].temperature + (year - lastYear)*0.015
            })),
            "Best Case": projectionYears.map(year => ({
                year, temperature: data[data.length-1].temperature + (year - lastYear)*0.005
            }))
        };
        const allData = [...data, ...Object.values(scenarios).flat()];
    
        const xScale = d3.scaleLinear()
            .domain([1959, 2100])
            .range([0, width]);
        const yScale = d3.scaleLinear()
            .domain([d3.min(allData, d => d.temperature)-0.45, d3.max(allData, d => d.temperature)+0.45])
            .range([height, 0]);
    
        // Grid
        g.append("g").attr("class", "grid")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(""));
        g.append("g").attr("class", "grid")
            .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(""));
    
        // Historical line
        const line = d3.line()
            .x(d => xScale(d.year))
            .y(d => yScale(d.temperature))
            .curve(d3.curveMonotoneX);
        g.append("path")
            .datum(data)
            .attr("class", "line temperature-line")
            .attr("d", line);
    
        // Projections
        const colors = {
            "Current Path": "#e74c3c",
            "Aggressive Action": "#f39c12",
            "Best Case": "#27ae60"
        };
        Object.entries(scenarios).forEach(([name, projData]) => {
            const fullData = [data[data.length-1], ...projData];
            const group = g.append("g")
                .attr("class", "scenario-group")
                .attr("data-scenario", name);
            group.append("path")
                .datum(fullData)
                .attr("class", "line projection-line")
                .attr("stroke", colors[name])
                .attr("d", line)
                .attr("opacity", 1);
            // Area
            const area = d3.area()
                .x(d => xScale(d.year))
                .y0(height)
                .y1(d => yScale(d.temperature))
                .curve(d3.curveMonotoneX);
            group.append("path")
                .datum(fullData)
                .attr("class", "area")
                .attr("fill", colors[name])
                .attr("fill-opacity", 0.12)
                .attr("d", area);
        });
    
        // Axes
        g.append("g").attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
        g.append("g").attr("class", "axis").call(d3.axisLeft(yScale));
        // Labels
        g.append("text").attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 22)
            .attr("x", 0 - (height / 2))
            .attr("text-anchor", "middle")
            .text("Temperature Anomaly (°C)");
        g.append("text").attr("class", "axis-label")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 12)
            .attr("text-anchor", "middle")
            .text("Year");
        // Vertical line at present
        g.append("line")
            .attr("x1", xScale(lastYear))
            .attr("x2", xScale(lastYear))
            .attr("y1", 0)
            .attr("y2", height)
            .attr("stroke", "#95a5a6")
            .attr("stroke-dasharray", "3,3");
        g.append("text")
            .attr("x", xScale(lastYear))
            .attr("y", -8)
            .attr("text-anchor", "middle")
            .attr("fill", "#616161")
            .attr("font-size", 12)
            .text("Present");
        // Interactive legend
        const legend = g.append("g")
            .attr("class", "legend")
            .attr("transform", `translate(${width - 165}, 22)`);
        Object.entries(colors).forEach(([name, color], i) => {
            const legendItem = legend.append("g")
                .attr("transform", `translate(0, ${i * 26})`)
                .style("cursor", "pointer")
                .on("click", function() {
                    const scenario = d3.select(`.scenario-group[data-scenario="${name}"]`);
                    const isHidden = scenario.attr("opacity") === "0.23";
                    scenario.transition().duration(200).attr("opacity", isHidden ? 1 : 0.23);
                    d3.select(this).select("rect").attr("opacity", isHidden ? 1 : 0.4);
                    d3.select(this).select("text").attr("opacity", isHidden ? 1 : 0.4);
                });
            legendItem.append("rect")
                .attr("width", 20).attr("height", 3)
                .attr("fill", color).attr("opacity", 1);
            legendItem.append("text")
                .attr("x", 27)
                .attr("y", 3)
                .attr("alignment-baseline", "middle")
                .attr("font-size", 15)
                .text(name);
        });
        // Annotations
        g.append("g").call(
            d3.annotation().annotations([
                {
                    note: {
                        title: "Critical Decision Point",
                        label: "Next decade determines our path"
                    },
                    x: xScale(2037), y: yScale(scenarios["Aggressive Action"][15].temperature),
                    dy: -55, dx: 55
                },
                {
                    note: {
                        title: "Potential 4°C Rise",
                        label: "‘Current Path’ leads to catastrophic warming"
                    },
                    x: xScale(2100), y: yScale(scenarios["Current Path"][scenarios["Current Path"].length-1].temperature),
                    dy: -28, dx: -105
                }
            ]).notePadding(7)
        );
    }
    
    // --- Tooltip Helpers ---
    function showTooltip(event, html) {
        const tooltip = document.getElementById('tooltip');
        tooltip.innerHTML = html;
        tooltip.style.opacity = 1;
        tooltip.style.left = (event.pageX + 10) + "px";
        tooltip.style.top = (event.pageY - 32) + "px";
    }
    function hideTooltip() {
        document.getElementById('tooltip').style.opacity = 0;
    }
    
    // --- Regression Helper ---
    function calculateRegression(data) {
        const n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
        data.forEach(([x, y]) => {
            sumX += x; sumY += y; sumXY += x * y; sumX2 += x * x; sumY2 += y * y;
        });
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        const r2 = Math.pow((n * sumXY - sumX * sumY) /
            Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY)), 2);
        return {slope, intercept, r2, predict: x => slope * x + intercept};
    }
    
    // Navigation
    function nextScene() { if (currentScene < scenes.length - 1) loadScene(currentScene + 1); }
    function previousScene() { if (currentScene > 0) loadScene(currentScene - 1); }
    document.addEventListener('keydown', e => {
        if (e.key === 'ArrowRight') nextScene();
        if (e.key === 'ArrowLeft') previousScene();
    });
    window.addEventListener('load', init);
</script>
</body>
</html>
